[[_ugtst_integ-test-support_bootstrapping]]
= Bootstrapping
:Notice: Licensed to the Apache Software Foundation (ASF) under one or more contributor license agreements. See the NOTICE file distributed with this work for additional information regarding copyright ownership. The ASF licenses this file to you under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at. http://www.apache.org/licenses/LICENSE-2.0 . Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR  CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
:_basedir: ../../
:_imagesdir: images/


Integration tests instantiate an Apache Isis "runtime" (as a singleton) within a JUnit test.
Because (depending on the size of your app) it takes a little time to bootstrap Apache Isis, the framework caches the runtime on a thread-local from one test to the next.

Newer releases of the framework reduce the amount of boilerplate to do this; this guide documents multiple versions.

The example code in this section is taken from the app generated by the xref:../ugfun/ugfun.adoc#_ugfun_getting-started_simpleapp-archetype[SimpleApp archetype].



== 1.15.0 onwards

In `1.15.0` the bootstrapping is accomplished using a combination of `AppManifestAbstract` (a framework-provided implementation of xref:../rgcms/rgcms.adoc#_rgcms_classes_AppManifest-bootstrapping[`AppManifest`]) and `IntegrationTestAbstract2` superclass.

For example, the xref:../ugfun/ugfun.adoc#_ugfun_getting-started_simpleapp-archetype[SimpleApp archetype]'s integration tests all inherit from this class:

[source,java]
----
public abstract class DomainAppIntegTestAbstract extends IntegrationTestAbstract2 {

    @BeforeClass
    public static void initSystem() {
        bootstrapUsing(new DomainAppAppManifest());
    }

}
----

where `DomainAppAppManifest` in turn is:

[source,java]
----
public class DomainAppAppManifest extends AppManifestAbstract {

    public static final Builder BUILDER = Builder.forModules(
                    SimpleModuleDomSubmodule.class,
                    DomainAppApplicationModuleFixtureSubmodule.class,
                    DomainAppApplicationModuleServicesSubmodule.class
            )
            .withConfigurationPropertiesFile(DomainAppAppManifest.class,
                    "isis.properties",
                    "authentication_shiro.properties",
                    "persistor_datanucleus.properties",
                    "viewer_restfulobjects.properties",
                    "viewer_wicket.properties"
            ).withAuthMechanism("shiro");

    public DomainAppAppManifest() {
        super(BUILDER);
    }
}
----

The `AppManifestAbstract` class (which is also used to bootstrap the regular app as well as integration tests) is discussed further xref:../rgcms/rgcms.adoc#_rgcms_classes_AppManifest-bootstrapping[here], while the `IntegrationTestAbstract2` class is discussed further xref:ugtst.adoc#_ugtst_integ-test-support_abstract-class[here].



== 1.13.0

In `1.13.0` the bootstrapping itself is typically performed by a "system initializer" class.
This is responsible for instantiating the Apache Isis runtime (based on a provided `AppManifest`) and binding it to a thread-local.

The `AppManifest.Util` class allows configuration properties for integration testing to be defined (replacing the `IsisConfigurationForJdoIntegTests` of earlier releases).

For example:

[source,java]
----
public class DomainAppSystemInitializer {
    public static void initIsft() {
        IsisSystemForTest isft = IsisSystemForTest.getElseNull();
        if(isft == null) {
            isft = new IsisSystemForTest.Builder()
                    .withLoggingAt(org.apache.log4j.Level.INFO)
                    .with(new DomainAppAppManifest() {
                        @Override
                        public Map<String, String> getConfigurationProperties() {
                            final Map<String, String> map = Maps.newHashMap();
                            Util.withJavaxJdoRunInMemoryProperties(map);
                            Util.withDataNucleusProperties(map);
                            Util.withIsisIntegTestProperties(map);
                            return map;
                        }
                    })
                    .build();
            isft.setUpSystem();
            IsisSystemForTest.set(isft);
        }
    }
}
----


The above code uses the `AppManifest.Util` helper class, which provides a number of static methods that can be used to set up xref:ugtst.adoc#_ugtst_integ-test-support_configuration-properties[configuration properties] appropriate for integration testing (eg run using an in-memory database).
This allows the responsibility of returning the configuration properties to belong exclusively to the `AppManifest`.

There are three such static methods:

[source,java]
----
public interface AppManifest {
  ...
  public static class Util {
    public static Map<String,String>
        withJavaxJdoRunInMemoryProperties(Map<String, String> map) { ... }   // <1>
    public static Map<String,String>
        withDataNucleusProperties(Map<String, String> map) { ... }           // <2>
    public static Map<String,String>
        withIsisIntegTestProperties(Map<String, String> map) { ... }         // <3>
  }
}
----
<1> sets up the `javax.jdo.option.Connection*` properties so as to run against an in-memory instance of HSQLDB
<2> sets up DataNucleus to automatically create the databse schema, as well as a number of other standard properties
(disable persistence by reachability, support mixed case identifiers, disable level 2 cache)
<3> sets up standard properties for the Apache Isis framework, most specifically to enable fixtures to be installed.




== 1.9.0

In `1.9.0` the `AppManifest` was introduced as mechanism to specify all parts (domain code, framework components, configuation properties) that make up a running application.

The suggested way to use this concept was using a "system initializer" class.
This uses a `IsisConfigurationForJdoIntegTests` class to bring together the configuration properties (discussed further xref:ugtst.adoc#_ugtst_integ-test-support_configuration-properties[here]) to bootstrap the application.

For example:

[source,java]
----
public class DomainAppSystemInitializer {
    public static void initIsft() {
        IsisSystemForTest isft = IsisSystemForTest.getElseNull();
        if(isft == null) {
            isft = new IsisSystemForTest.Builder()
                    .withLoggingAt(org.apache.log4j.Level.INFO)
                    .with(new DomainAppAppManifest())
                    .with(new IsisConfigurationForJdoIntegTests())
                    .build()
                    .setUpSystem();
            IsisSystemForTest.set(isft);
        }
    }
}
----

where `DomainAppAppManifest` in turn is defined as:

[source,java]
----
public class DomainAppAppManifest implements AppManifest {
    @Override
    public List<Class<?>> getModules() {
        return Arrays.asList(
                domainapp.dom.DomainAppDomainModule.class,
                domainapp.fixture.DomainAppFixtureModule.class,
                domainapp.app.DomainAppAppModule.class
        );
    }
    ...
}
----

Further details on bootstrapping with the `AppManifest` can be found in the xref:../rgcms/rgcms.adoc#_rgcms_classes_AppManifest-bootstrapping[reference guide].



== 1.8.0 and earlier

Prior to 1.9.0, the services and entities had to be specified in two separate locations.  The suggested way to do this was to introduce a subclass of the `IsisSystemForTest.Builder` class:

[source,java]
----
private static class DomainAppSystemBuilder extends IsisSystemForTest.Builder {      // <1>
    public DomainAppSystemBuilder() {
        withLoggingAt(org.apache.log4j.Level.INFO);
        with(testConfiguration());
        with(new DataNucleusPersistenceMechanismInstaller());                        // <2>
        withServicesIn( "domainapp" );                                               // <3>
    }
    private static IsisConfiguration testConfiguration() {
        final IsisConfigurationForJdoIntegTests testConfiguration =
            new IsisConfigurationForJdoIntegTests();                                 // <4>
        testConfiguration.addRegisterEntitiesPackagePrefix("domainapp.dom.modules"); // <5>
        return testConfiguration;
    }
}
----
<1> subclass the framework-provided `IsisSystemForTest.Builder`.
<2> equivalent to `isis.persistor=datanucleus` in `isis.properties`
<3> specify the `isis.services` key in `isis.properties` (where "domainapp" is the base package for all classes within the app)
<4> `IsisConfigurationForJdoIntegTests` has pre-canned configuration for using an in-memory HSQLDB and other standard settings; more on this below.
<5> equivalent to `isis.persistor.datanucleus.RegisterEntities.packagePrefix` key (typically in `persistor_datanucleus.properties`)



This builder could then be used within the system initializer:

[source,java]
----
public class DomainAppSystemInitializer {
    public static void initIsft() {
        IsisSystemForTest isft = IsisSystemForTest.getElseNull();
        if(isft == null) {
            isft = new DomainAppSystemBuilder()    // <1>
                            .build()
                            .setUpSystem();
            IsisSystemForTest.set(isft);           // <2>
        }
    }
    private static class DomainAppSystemBuilder
        extends IsisSystemForTest.Builder { ... }
}
----
<1> instantiates and initializes the Apache Isis runtime (the `IsisSystemForTest` class)
<2> binds the runtime to a thread-local.


